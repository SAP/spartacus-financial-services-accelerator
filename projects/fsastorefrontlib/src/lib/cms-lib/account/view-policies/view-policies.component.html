<ng-container *ngIf="component$ | async as component">
    <div *ngIf="!anonymous$; else anonymousLogin">
        <ng-container *ngIf="policiesLoaded$ | async; else loading">
            <div *ngIf="policies$ | async as policies">
                <div class="review__wrapper">
                    <div class="review__policies" *ngIf="policies?.insurancePolicies?.length > 0; else noPolicies">
                        <div class="my-policies">
                            <h2 class="my-policies__title">{{ 'policy.viewPolicies' | cxTranslate }}</h2>
                            <ul>
                                <ng-container *ngTemplateOutlet="policiesList; context:{policies: policies, max: (allPoliciesDisplayed$ ? policies?.insurancePolicies?.length : component.numberOfPoliciesToDisplay)}"></ng-container>
                            </ul>
                            <div *ngIf = "policies?.insurancePolicies?.length > component.numberOfPoliciesToDisplay">
                                <ng-container *ngTemplateOutlet="showAllPoliciesButton context: {showAll: (allPoliciesDisplayed$ ? false : true)}"></ng-container>
                            </div>  
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>
</ng-container>

<ng-template #policiesList let-policies="policies" let-max="max">
<div *ngFor="let policy of policies.insurancePolicies | slice: 0:max">
    <li class="my-policies__my-policy">
        <a routerLink="/my-account/my-policies/{{policy.policyNumber}}/{{policy.contractNumber}}" routerLinkActive="active">
            <div class="my-policies__data-container">
                <span class="image-wrapper">
                        <img class="image-item" [src]="getBaseUrl()+policy.mainProduct.coverageProduct.images[0].url" alt="">
                    </span>
                <div class="my-policies__name-number">
                    <span class="my-policies__name">{{policy.categoryData?.name}}</span>
                    <span class="my-policies__number">{{policy.contractNumber}}</span>
                </div>
                    <span class="my-policies__add-infos">{{policy.policyEndDate}}</span>
            </div>
        </a>
    </li>
</div>
</ng-template>

<ng-template #showAllPoliciesButton let-showAll="showAll">
    <button class="secondary-button" (click)="showAllPolicies(showAll);">
        {{policyButtonText}}
    </button>
</ng-template>

<ng-template #noPolicies>
    <div class="none-policies">
        <h2 class="none-policies__title">{{ 'policy.viewPolicies' | cxTranslate }}</h2>
        <p class="none-policies__content">- {{ 'policy.finishQuoteToGetPolicy' | cxTranslate }}</p>
    </div>
</ng-template>

<ng-template #anonymousLogin>
    <button routerLink="/login" class="secondary-button">{{ 'policy.viewYourPolicies' | cxTranslate }}</button>
</ng-template>

<ng-template #loading>
    <cx-spinner></cx-spinner>
</ng-template>